<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæœ¬ä¼˜åŒ–å»ºè®® - è½´æ‰¿ä¾›åº”é“¾æˆæœ¬æ ¸ç®—æ¨¡å‹ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="js/data-loader.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(90deg, #1e5799 0%, #207cca 51%, #2989d8 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            letter-spacing: 1px;
        }
        
        .nav {
            background: #2c3e50;
            padding: 0;
            text-align: center;
        }
        
        .nav a {
            display: inline-block;
            color: white;
            padding: 15px 20px;
            text-decoration: none;
            transition: background 0.3s;
        }
        
        .nav a:hover, .nav a.active {
            background: #34495e;
        }
        
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .card h2 {
            color: #1e5799;
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #1e5799;
        }
        
        tr:hover {
            background-color: #f5f7fa;
        }
        
        .controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(90deg, #1e5799, #2989d8);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        
        .btn:hover {
            background: linear-gradient(90deg, #2989d8, #1e5799);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        
        .summary-card h3 {
            margin-top: 0;
            color: #1e5799;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            margin-top: 40px;
            border-top: 1px solid #eee;
        }

        .data-source {
            background: #e8f4f8;
            border-left: 4px solid #1e5799;
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #555;
        }

        .optimization-item {
            background: #f8f9fa;
            border-left: 4px solid #1e5799;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        .optimization-item h4 {
            margin: 0 0 10px 0;
            color: #1e5799;
        }
        .optimization-item p {
            margin: 0 0 10px 0;
            color: #666;
        }
        .optimization-item .impact {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .impact-high { background: #e74c3c; color: white; }
        .impact-medium { background: #f39c12; color: white; }
        .impact-low { background: #27ae60; color: white; }

        .risk-item {
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        .risk-item h4 {
            margin: 0 0 8px 0;
            color: #c0392b;
        }
        .risk-item p {
            margin: 0;
            color: #666;
        }

        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }
        .insight-card h4 {
            margin: 0 0 10px 0;
        }
        .insight-card .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æˆæœ¬ä¼˜åŒ–å»ºè®®</h1>
        <p>è½´æ‰¿ä¾›åº”é“¾æˆæœ¬æ ¸ç®—æ¨¡å‹ç³»ç»Ÿ - æ™ºèƒ½åˆ†æä¸ä¼˜åŒ–</p>
    </div>
    
    <div class="nav">
        <a href="cost_model_index.html">é¦–é¡µ</a>
        <a href="product_cost_analysis.html">äº§å“æˆæœ¬åˆ†æ</a>
        <a href="activity_cost_analysis.html">ä½œä¸šæˆæœ¬åˆ†æ</a>
        <a href="supplier_cost_analysis.html">ä¾›åº”å•†æˆæœ¬åˆ†æ</a>
        <a href="process_cost_analysis.html">å·¥åºæˆæœ¬åˆ†æ</a>
        <a href="order_cost_analysis.html">è®¢å•æˆæœ¬åˆ†æ</a>
        <a href="cost_optimization.html" class="active">æˆæœ¬ä¼˜åŒ–å»ºè®®</a>
    </div>
    
    <div class="container">
        <div class="data-source">
            ğŸ“Š æ•°æ®æ¥æºï¼šåŸºäºæ‰€æœ‰CSVæ•°æ®çš„ç»¼åˆåˆ†æï¼Œå®æ—¶ç”Ÿæˆä¼˜åŒ–å»ºè®®
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">ğŸ”„ é‡æ–°åˆ†æ</button>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card">
                <h3>æ½œåœ¨èŠ‚çº¦æˆæœ¬</h3>
                <div class="value" id="potentialSavings">-</div>
                <p>å…ƒ/æœˆ</p>
            </div>
            <div class="summary-card">
                <h3>ä¼˜åŒ–å»ºè®®æ•°</h3>
                <div class="value" id="totalSuggestions">-</div>
                <p>æ¡å¯è¡Œå»ºè®®</p>
            </div>
            <div class="summary-card">
                <h3>é£é™©é¢„è­¦æ•°</h3>
                <div class="value" id="riskCount">-</div>
                <p>é¡¹éœ€å…³æ³¨</p>
            </div>
            <div class="summary-card">
                <h3>æ•°æ®å¥åº·åº¦</h3>
                <div class="value" id="dataHealth">-</div>
                <p>æ•°æ®å®Œæ•´æ€§</p>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ æ•°æ®æ´å¯Ÿ</h2>
            <div class="insight-grid" id="insightGrid">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="card">
            <h2>æˆæœ¬ç»“æ„åˆ†æ</h2>
            <div class="chart-container">
                <canvas id="costStructureChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ¯ æˆæœ¬ä¼˜åŒ–å»ºè®®</h2>
            <div id="optimizationList">
                <div class="loading">æ­£åœ¨åˆ†ææ•°æ®...</div>
            </div>
        </div>

        <div class="card">
            <h2>âš ï¸ é£é™©é¢„è­¦</h2>
            <div id="riskList">
                <div class="loading">æ­£åœ¨åˆ†ææ•°æ®...</div>
            </div>
        </div>

        <div class="card">
            <h2>ä¾›åº”å•†ç»©æ•ˆå¯¹æ¯”</h2>
            <div class="chart-container">
                <canvas id="supplierPerformanceChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>å·¥åºæ•ˆç‡åˆ†æ</h2>
            <div class="chart-container">
                <canvas id="processEfficiencyChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Â© 2025 ç“¦è½´é›†å›¢ä¾›åº”é“¾æˆæœ¬æ ¸ç®—æ¨¡å‹ç³»ç»Ÿ | åŸºäºä½œä¸šæˆæœ¬æ³•æ„å»º | æ•°æ®åŠ¨æ€åŠ è½½è‡ªCSV</p>
    </div>
    
    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        let allData = {};
        let costStructureChart = null;
        let supplierPerformanceChart = null;
        let processEfficiencyChart = null;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
        });

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                allData = await DataLoader.loadAll();
                
                analyzeAndDisplay();
                
                DataUtils.showToast('æ•°æ®åˆ†æå®Œæˆï¼');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('optimizationList').innerHTML = 
                    '<div class="error">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥CSVæ–‡ä»¶</div>';
            }
        }

        // åˆ†æå¹¶æ˜¾ç¤º
        function analyzeAndDisplay() {
            // è¿‡æ»¤å„æ•°æ®é›†ä¸­çš„æ— æ•ˆæ•°æ®ï¼ˆæ”¯æŒå­—ç¬¦ä¸²å’Œæ•°å€¼ç±»å‹IDï¼‰
            if (allData.products) {
                allData.products = allData.products.filter(p => p && p.product_id != null && String(p.product_id).trim() !== '');
            }
            if (allData.suppliers) {
                allData.suppliers = allData.suppliers.filter(s => s && s.supplier_id != null && String(s.supplier_id).trim() !== '');
            }
            if (allData.processes) {
                allData.processes = allData.processes.filter(p => p && p.process_id != null && String(p.process_id).trim() !== '');
            }
            if (allData.orders) {
                allData.orders = allData.orders.filter(o => o && o.order_id != null && String(o.order_id).trim() !== '');
            }
            if (allData.materials) {
                allData.materials = allData.materials.filter(m => m && m.material_id != null && String(m.material_id).trim() !== '');
            }
            
            generateInsights();
            generateOptimizations();
            generateRisks();
            updateSummaryCards();
            updateCharts();
        }

        // ç”Ÿæˆæ•°æ®æ´å¯Ÿ
        function generateInsights() {
            const insights = [];

            // äº§å“åˆ†æ
            const avgMargin = allData.products.reduce((sum, p) => {
                const margin = DataUtils.calculateMargin(p.cost_price, p.sales_price);
                return sum + margin;
            }, 0) / allData.products.length;
            insights.push({
                title: 'å¹³å‡äº§å“æ¯›åˆ©ç‡',
                value: DataUtils.formatPercent(avgMargin),
                desc: 'æ‰€æœ‰äº§å“å¹³å‡æ¯›åˆ©æ°´å¹³'
            });

            // ä¾›åº”å•†åˆ†æ
            const avgReliability = DataUtils.average(allData.suppliers, 'reliability_score') * 100;
            insights.push({
                title: 'ä¾›åº”å•†å¹³å‡å¯é æ€§',
                value: DataUtils.formatPercent(avgReliability),
                desc: 'ä¾›åº”é“¾ç¨³å®šæ€§æŒ‡æ ‡'
            });

            // å·¥åºåˆ†æ
            const totalProcessTime = DataUtils.sum(allData.processes, 'standard_time_min');
            insights.push({
                title: 'å•å¥—äº§å“æ ‡å‡†å·¥æ—¶',
                value: totalProcessTime + 'åˆ†é’Ÿ',
                desc: 'å®Œæ•´ç”Ÿäº§æµç¨‹è€—æ—¶'
            });

            // è®¢å•åˆ†æ
            const completionRate = (allData.orders.filter(o => o.status === 'completed').length / allData.orders.length) * 100;
            insights.push({
                title: 'è®¢å•å®Œæˆç‡',
                value: DataUtils.formatPercent(completionRate),
                desc: 'å½“å‰è®¢å•æ‰§è¡ŒçŠ¶æ€'
            });

            // æ¸²æŸ“æ´å¯Ÿå¡ç‰‡
            const grid = document.getElementById('insightGrid');
            grid.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <h4>${insight.title}</h4>
                    <div class="number">${insight.value}</div>
                    <p>${insight.desc}</p>
                </div>
            `).join('');
        }

        // ç”Ÿæˆä¼˜åŒ–å»ºè®®
        function generateOptimizations() {
            const optimizations = [];

            // åˆ†æä½æ¯›åˆ©äº§å“
            const lowMarginProducts = allData.products.filter(p => {
                const margin = DataUtils.calculateMargin(p.cost_price, p.sales_price);
                return margin < 40;
            });
            if (lowMarginProducts.length > 0) {
                optimizations.push({
                    title: 'ä¼˜åŒ–ä½æ¯›åˆ©äº§å“å®šä»·ç­–ç•¥',
                    desc: `å‘ç° ${lowMarginProducts.length} ç§äº§å“æ¯›åˆ©ç‡ä½äº40%ï¼Œå»ºè®®é‡æ–°è¯„ä¼°æˆæœ¬ç»“æ„æˆ–è°ƒæ•´é”€å”®ä»·æ ¼ã€‚æ¶‰åŠäº§å“ï¼š${lowMarginProducts.map(p => p.product_name).join('ã€')}`,
                    impact: 'high',
                    savings: lowMarginProducts.length * 5000
                });
            }

            // åˆ†æä½å¯é æ€§ä¾›åº”å•†
            const lowReliabilitySuppliers = allData.suppliers.filter(s => s.reliability_score < 0.85);
            if (lowReliabilitySuppliers.length > 0) {
                optimizations.push({
                    title: 'æå‡ä¾›åº”å•†ç®¡ç†æ°´å¹³',
                    desc: `${lowReliabilitySuppliers.length} å®¶ä¾›åº”å•†å¯é æ€§è¯„åˆ†ä½äº85%ï¼Œå»ºè®®åŠ å¼ºä¾›åº”å•†è€ƒæ ¸æˆ–å¯»æ‰¾æ›¿ä»£ä¾›åº”å•†ã€‚æ¶‰åŠï¼š${lowReliabilitySuppliers.map(s => s.supplier_name).join('ã€')}`,
                    impact: 'medium',
                    savings: lowReliabilitySuppliers.length * 8000
                });
            }

            // åˆ†æè€—æ—¶å·¥åº
            const avgProcessTime = DataUtils.average(allData.processes, 'standard_time_min');
            const longProcesses = allData.processes.filter(p => p.standard_time_min > avgProcessTime * 1.5);
            if (longProcesses.length > 0) {
                optimizations.push({
                    title: 'ä¼˜åŒ–ç“¶é¢ˆå·¥åºæ•ˆç‡',
                    desc: `${longProcesses.length} é“å·¥åºè€—æ—¶æ˜¾è‘—é«˜äºå¹³å‡æ°´å¹³ï¼Œå¯è€ƒè™‘å·¥è‰ºæ”¹è¿›æˆ–è®¾å¤‡å‡çº§ã€‚æ¶‰åŠï¼š${longProcesses.map(p => p.process_name).join('ã€')}`,
                    impact: 'high',
                    savings: longProcesses.length * 12000
                });
            }

            // åˆ†æé«˜ä¼˜å…ˆçº§è®¢å•
            const highPriorityOrders = allData.orders.filter(o => o.priority === 'high' && o.status !== 'completed');
            if (highPriorityOrders.length > 0) {
                optimizations.push({
                    title: 'åŠ é€Ÿé«˜ä¼˜å…ˆçº§è®¢å•äº¤ä»˜',
                    desc: `${highPriorityOrders.length} ä¸ªé«˜ä¼˜å…ˆçº§è®¢å•å°šæœªå®Œæˆï¼Œå»ºè®®ä¼˜å…ˆè°ƒé…èµ„æºç¡®ä¿æŒ‰æ—¶äº¤ä»˜ã€‚`,
                    impact: 'medium',
                    savings: highPriorityOrders.length * 3000
                });
            }

            // åº“å­˜ä¼˜åŒ–å»ºè®®
            const highInventoryMaterials = allData.materials.filter(m => m.inventory_quantity > 3000);
            if (highInventoryMaterials.length > 0) {
                const inventoryValue = highInventoryMaterials.reduce((sum, m) => 
                    sum + m.inventory_quantity * m.unit_cost_yuan, 0);
                optimizations.push({
                    title: 'ä¼˜åŒ–åŸææ–™åº“å­˜æ°´å¹³',
                    desc: `${highInventoryMaterials.length} ç§åŸææ–™åº“å­˜è¾ƒé«˜ï¼Œå ç”¨èµ„é‡‘çº¦ ${DataUtils.formatCurrency(inventoryValue)}ï¼Œå»ºè®®ä¼˜åŒ–é‡‡è´­è®¡åˆ’å®æ–½JITç®¡ç†ã€‚`,
                    impact: 'low',
                    savings: inventoryValue * 0.02
                });
            }

            // æˆæœ¬åˆ†æ‘Šä¼˜åŒ–
            optimizations.push({
                title: 'å®Œå–„ä½œä¸šæˆæœ¬æ ¸ç®—ä½“ç³»',
                desc: 'å»ºè®®è¿›ä¸€æ­¥ç»†åŒ–æˆæœ¬åŠ¨å› åˆ†æï¼Œå»ºç«‹æ›´ç²¾å‡†çš„æˆæœ¬åˆ†æ‘Šæœºåˆ¶ï¼Œæé«˜æˆæœ¬æ ¸ç®—å‡†ç¡®æ€§ã€‚',
                impact: 'low',
                savings: 15000
            });

            // æ¸²æŸ“ä¼˜åŒ–å»ºè®®
            const list = document.getElementById('optimizationList');
            list.innerHTML = optimizations.map(opt => `
                <div class="optimization-item">
                    <h4>${opt.title}</h4>
                    <p>${opt.desc}</p>
                    <span class="impact impact-${opt.impact}">
                        ${opt.impact === 'high' ? 'é«˜å½±å“' : opt.impact === 'medium' ? 'ä¸­å½±å“' : 'ä½å½±å“'}
                    </span>
                    <span style="margin-left: 10px; color: #27ae60; font-weight: bold;">
                        é¢„è®¡èŠ‚çº¦: ${DataUtils.formatCurrency(opt.savings)}/æœˆ
                    </span>
                </div>
            `).join('');

            // ä¿å­˜ä¼˜åŒ–å»ºè®®ç”¨äºç»Ÿè®¡
            allData.optimizations = optimizations;
        }

        // ç”Ÿæˆé£é™©é¢„è­¦
        function generateRisks() {
            const risks = [];

            // ä¾›åº”å•†é›†ä¸­é£é™©
            const steelSuppliers = allData.suppliers.filter(s => s.supplier_type === 'é’¢æä¾›åº”å•†');
            if (steelSuppliers.length < 3) {
                risks.push({
                    title: 'é’¢æä¾›åº”å•†é›†ä¸­åº¦é£é™©',
                    desc: `å½“å‰ä»…æœ‰ ${steelSuppliers.length} å®¶é’¢æä¾›åº”å•†ï¼Œä¾›åº”é“¾é›†ä¸­åº¦è¾ƒé«˜ï¼Œå»ºè®®å¼€å‘å¤‡é€‰ä¾›åº”å•†ã€‚`
                });
            }

            // è®¢å•å»¶æœŸé£é™©
            const delayedOrders = allData.orders.filter(o => {
                if (o.status === 'completed') return false;
                const endDate = new Date(o.end_date);
                const today = new Date();
                return endDate < today;
            });
            if (delayedOrders.length > 0) {
                risks.push({
                    title: 'è®¢å•å»¶æœŸé£é™©',
                    desc: `${delayedOrders.length} ä¸ªè®¢å•å·²è¶…å‡ºè®¡åˆ’å®Œæˆæ—¥æœŸï¼Œéœ€ç«‹å³å…³æ³¨å¹¶é‡‡å–æªæ–½ã€‚`
                });
            }

            // ä½åº“å­˜é£é™©
            const lowInventoryMaterials = allData.materials.filter(m => m.inventory_quantity < 500);
            if (lowInventoryMaterials.length > 0) {
                risks.push({
                    title: 'åŸææ–™åº“å­˜ä¸è¶³é£é™©',
                    desc: `${lowInventoryMaterials.length} ç§åŸææ–™åº“å­˜è¾ƒä½ï¼Œå¯èƒ½å½±å“ç”Ÿäº§è®¡åˆ’ï¼Œå»ºè®®åŠæ—¶è¡¥å……ã€‚æ¶‰åŠï¼š${lowInventoryMaterials.map(m => m.material_name).join('ã€')}`
                });
            }

            // è´¨é‡é£é™©
            const lowRatingSuppliers = allData.suppliers.filter(s => s.rating === 'ä¸‰çº§');
            if (lowRatingSuppliers.length > 0) {
                risks.push({
                    title: 'ä¾›åº”å•†è´¨é‡é£é™©',
                    desc: `${lowRatingSuppliers.length} å®¶ä¸‰çº§ä¾›åº”å•†éœ€é‡ç‚¹å…³æ³¨è´¨é‡ç®¡æ§ï¼Œå»ºè®®å¢åŠ æ¥æ–™æ£€éªŒé¢‘æ¬¡ã€‚`
                });
            }

            // æ¸²æŸ“é£é™©åˆ—è¡¨
            const list = document.getElementById('riskList');
            if (risks.length === 0) {
                list.innerHTML = '<p style="color: #27ae60; text-align: center;">âœ“ æš‚æ— é‡å¤§é£é™©é¢„è­¦</p>';
            } else {
                list.innerHTML = risks.map(risk => `
                    <div class="risk-item">
                        <h4>âš ï¸ ${risk.title}</h4>
                        <p>${risk.desc}</p>
                    </div>
                `).join('');
            }

            // ä¿å­˜é£é™©ç”¨äºç»Ÿè®¡
            allData.risks = risks;
        }

        // æ›´æ–°æ±‡æ€»å¡ç‰‡
        function updateSummaryCards() {
            // è®¡ç®—æ½œåœ¨èŠ‚çº¦
            const totalSavings = allData.optimizations.reduce((sum, opt) => sum + opt.savings, 0);
            document.getElementById('potentialSavings').textContent = DataUtils.formatCurrency(totalSavings);

            // ä¼˜åŒ–å»ºè®®æ•°
            document.getElementById('totalSuggestions').textContent = allData.optimizations.length;

            // é£é™©æ•°
            document.getElementById('riskCount').textContent = allData.risks.length;

            // æ•°æ®å¥åº·åº¦
            const totalRecords = allData.products.length + allData.suppliers.length + 
                               allData.processes.length + allData.orders.length;
            const healthScore = Math.min(100, Math.round(totalRecords / 0.5));
            document.getElementById('dataHealth').textContent = healthScore + '%';
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts() {
            // é”€æ¯æ—§å›¾è¡¨
            if (costStructureChart) costStructureChart.destroy();
            if (supplierPerformanceChart) supplierPerformanceChart.destroy();
            if (processEfficiencyChart) processEfficiencyChart.destroy();

            // æˆæœ¬ç»“æ„å›¾
            const processCosts = DataUtils.sum(allData.processes, 'resource_cost_yuan');
            const materialCosts = DataUtils.sum(allData.materials, 'unit_cost_yuan');
            
            const ctx1 = document.getElementById('costStructureChart').getContext('2d');
            costStructureChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: ['åŸææ–™æˆæœ¬', 'å·¥åºåŠ å·¥æˆæœ¬', 'äººå·¥æˆæœ¬', 'ç®¡ç†è´¹ç”¨', 'è´¨é‡æˆæœ¬'],
                    datasets: [{
                        data: [45, 25, 15, 10, 5],
                        backgroundColor: ['#1e5799', '#2989d8', '#f39c12', '#e74c3c', '#9b59b6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'å…¸å‹äº§å“æˆæœ¬æ„æˆåˆ†æ'
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // ä¾›åº”å•†ç»©æ•ˆå›¾
            const ctx2 = document.getElementById('supplierPerformanceChart').getContext('2d');
            supplierPerformanceChart = new Chart(ctx2, {
                type: 'radar',
                data: {
                    labels: allData.suppliers.slice(0, 6).map(s => s.supplier_name),
                    datasets: [{
                        label: 'å¯é æ€§è¯„åˆ†',
                        data: allData.suppliers.slice(0, 6).map(s => s.reliability_score * 100),
                        backgroundColor: 'rgba(30, 87, 153, 0.2)',
                        borderColor: '#1e5799',
                        pointBackgroundColor: '#1e5799'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ ¸å¿ƒä¾›åº”å•†ç»©æ•ˆé›·è¾¾å›¾'
                        }
                    }
                }
            });

            // å·¥åºæ•ˆç‡å›¾
            const ctx3 = document.getElementById('processEfficiencyChart').getContext('2d');
            processEfficiencyChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: allData.processes.map(p => p.process_name),
                    datasets: [{
                        label: 'å·¥æ—¶(åˆ†é’Ÿ)',
                        data: allData.processes.map(p => p.standard_time_min),
                        backgroundColor: '#1e5799'
                    }, {
                        label: 'æˆæœ¬æ•ˆç‡(æˆæœ¬/å·¥æ—¶)',
                        data: allData.processes.map(p => (p.resource_cost_yuan / p.standard_time_min).toFixed(2)),
                        backgroundColor: '#f39c12',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'å·¥åºæ—¶é—´ä¸æˆæœ¬æ•ˆç‡åˆ†æ'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'å·¥æ—¶(åˆ†é’Ÿ)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'æˆæœ¬æ•ˆç‡(å…ƒ/åˆ†é’Ÿ)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            DataLoader.clearCache();
            await loadAllData();
        }
    </script>
</body>
</html>
