<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“æˆæœ¬æ¨¡å‹è®¡ç®—å™¨ - 6206è½´æ‰¿</title>
    <style>
        * { box-sizing: border-box; }

        body {
            font-family: "Microsoft YaHei", "SimSun", Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .header {
            background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
            color: white;
            padding: 30px;
            margin: -40px -40px 30px -40px;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }

        .header h1 {
            font-size: 28pt;
            margin: 0 0 10px 0;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 13pt;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 12pt;
            font-weight: bold;
            color: #666;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e3f2fd;
            color: #2196f3;
        }

        .tab.active {
            background: #2196f3;
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: #2196f3;
            font-size: 18pt;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #2196f3;
        }

        h3 {
            color: #1976d2;
            font-size: 14pt;
            margin: 20px 0 15px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        thead {
            background: #2196f3;
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e3f2fd;
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11pt;
        }

        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        .btn {
            padding: 12px 30px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 12pt;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn:hover {
            background: #1565c0;
            transform: scale(1.05);
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-success:hover {
            background: #388e3c;
        }

        .summary-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196f3;
            padding: 25px;
            margin: 25px 0;
            border-radius: 8px;
        }

        .cost-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .cost-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .cost-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 12pt;
        }

        .cost-card .amount {
            font-size: 24pt;
            font-weight: bold;
            color: #2196f3;
            margin: 10px 0;
        }

        .cost-card .percentage {
            font-size: 14pt;
            color: #666;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #ffebee;
            border-left: 5px solid #f44336;
            color: #c62828;
        }

        .alert-success {
            background: #e8f5e9;
            border-left: 5px solid #4caf50;
            color: #2e7d32;
        }

        .highlight-row {
            background: #fff59d !important;
            font-weight: bold;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>äº§å“æˆæœ¬æ¨¡å‹è®¡ç®—å™¨</h1>
            <p>åŸºäºä½œä¸šæˆæœ¬æ³•(ABC)çš„6206æ·±æ²Ÿçƒè½´æ‰¿æˆæœ¬æ ¸ç®—ç³»ç»Ÿ</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('tab1')">ğŸ“Š åŸºç¡€æ•°æ®</button>
            <button class="tab" onclick="showTab('tab2')">ğŸ”§ BOMä¸ææ–™æˆæœ¬</button>
            <button class="tab" onclick="showTab('tab3')">âš™ï¸ å·¥åºæˆæœ¬</button>
            <button class="tab" onclick="showTab('tab4')">ğŸ’° æˆæœ¬æ±‡æ€»</button>
            <button class="tab" onclick="showTab('tab5')">ğŸ“ˆ æˆæœ¬åˆ†æ</button>
        </div>

        <!-- æ ‡ç­¾é¡µ1ï¼šåŸºç¡€æ•°æ® -->
        <div id="tab1" class="tab-content active">
            <h2>åŸºç¡€æ•°æ®ç®¡ç†</h2>

            <h3>ç‰©æ–™ä¸»æ•°æ®</h3>
            <table id="materialTable">
                <thead>
                    <tr>
                        <th>ç‰©æ–™ç¼–ç </th>
                        <th>ç‰©æ–™åç§°</th>
                        <th>è§„æ ¼å‹å·</th>
                        <th>å•ä½</th>
                        <th>å•ä»·(å…ƒ)</th>
                        <th>æŸè€—ç‡(%)</th>
                    </tr>
                </thead>
                <tbody id="materialTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>

            <h3>å·¥åºä¸»æ•°æ®</h3>
            <table id="processTable">
                <thead>
                    <tr>
                        <th>å·¥åºç¼–ç </th>
                        <th>å·¥åºåç§°</th>
                        <th>å·¥èµ„ç‡(å…ƒ/å°æ—¶)</th>
                        <th>æœˆåˆ¶é€ è´¹ç”¨(å…ƒ)</th>
                        <th>ä½œä¸šåŠ¨å› </th>
                        <th>æœˆåŠ¨å› æ€»é‡</th>
                        <th>è´¹ç”¨åˆ†é…ç‡(å…ƒ/å°æ—¶)</th>
                    </tr>
                </thead>
                <tbody id="processTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>

            <div class="summary-box">
                <h3>ğŸ’¡ è¯´æ˜</h3>
                <p><strong>ç‰©æ–™ä¸»æ•°æ®ï¼š</strong>åŒ…å«æ‰€æœ‰åŸææ–™çš„åŸºæœ¬ä¿¡æ¯å’Œä»·æ ¼ã€‚å•ä»·é‡‡ç”¨ç§»åŠ¨å¹³å‡ä»·ï¼ŒæŸè€—ç‡åŸºäºå†å²ç»Ÿè®¡æ•°æ®ã€‚</p>
                <p><strong>å·¥åºä¸»æ•°æ®ï¼š</strong>åŒ…å«å„å·¥åºçš„äººå·¥æˆæœ¬å’Œåˆ¶é€ è´¹ç”¨ä¿¡æ¯ã€‚è´¹ç”¨åˆ†é…ç‡ = æœˆåˆ¶é€ è´¹ç”¨ Ã· æœˆåŠ¨å› æ€»é‡ã€‚</p>
                <p><strong>æ•°æ®æ¥æºï¼š</strong>ç‰©æ–™ä»·æ ¼æ¥è‡ªERPç³»ç»Ÿï¼Œå·¥èµ„ç‡æ¥è‡ªäººåŠ›èµ„æºéƒ¨ï¼Œåˆ¶é€ è´¹ç”¨æ¥è‡ªè´¢åŠ¡éƒ¨é—¨ã€‚</p>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ3ï¼šå·¥åºæˆæœ¬ -->
        <div id="tab3" class="tab-content">
            <h2>å·¥åºæˆæœ¬æ˜ç»†è®¡ç®—</h2>

            <h3>å†…åœˆåŠ å·¥æˆæœ¬</h3>
            <table id="innerRingTable">
                <thead>
                    <tr>
                        <th>å·¥åº</th>
                        <th>å·¥æ—¶(åˆ†)</th>
                        <th>å·¥æ—¶(å°æ—¶)</th>
                        <th>å·¥èµ„ç‡(å…ƒ/h)</th>
                        <th>äººå·¥æˆæœ¬(å…ƒ)</th>
                        <th>è´¹ç”¨ç‡(å…ƒ/h)</th>
                        <th>åˆ¶é€ è´¹ç”¨(å…ƒ)</th>
                        <th>å·¥åºæˆæœ¬(å…ƒ)</th>
                        <th>ç´¯è®¡æˆæœ¬(å…ƒ)</th>
                    </tr>
                </thead>
                <tbody id="innerRingTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>

            <h3>å¤–åœˆåŠ å·¥æˆæœ¬</h3>
            <table id="outerRingTable">
                <thead>
                    <tr>
                        <th>å·¥åº</th>
                        <th>å·¥æ—¶(åˆ†)</th>
                        <th>å·¥æ—¶(å°æ—¶)</th>
                        <th>å·¥èµ„ç‡(å…ƒ/h)</th>
                        <th>äººå·¥æˆæœ¬(å…ƒ)</th>
                        <th>è´¹ç”¨ç‡(å…ƒ/h)</th>
                        <th>åˆ¶é€ è´¹ç”¨(å…ƒ)</th>
                        <th>å·¥åºæˆæœ¬(å…ƒ)</th>
                        <th>ç´¯è®¡æˆæœ¬(å…ƒ)</th>
                    </tr>
                </thead>
                <tbody id="outerRingTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>

            <h3>è£…é…ä¸æ£€éªŒæˆæœ¬</h3>
            <table id="assemblyTable">
                <thead>
                    <tr>
                        <th>å·¥åº</th>
                        <th>å·¥æ—¶(åˆ†)</th>
                        <th>å·¥æ—¶(å°æ—¶)</th>
                        <th>å·¥èµ„ç‡(å…ƒ/h)</th>
                        <th>äººå·¥æˆæœ¬(å…ƒ)</th>
                        <th>è´¹ç”¨ç‡(å…ƒ/h)</th>
                        <th>åˆ¶é€ è´¹ç”¨(å…ƒ)</th>
                        <th>å·¥åºæˆæœ¬(å…ƒ)</th>
                    </tr>
                </thead>
                <tbody id="assemblyTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>

            <div class="summary-box">
                <h3>ğŸ“ è®¡ç®—å…¬å¼</h3>
                <p><strong>å·¥æ—¶(å°æ—¶) = æ ‡å‡†å·¥æ—¶(åˆ†é’Ÿ) Ã· 60</strong></p>
                <p><strong>äººå·¥æˆæœ¬ = å·¥æ—¶ Ã— å·¥èµ„ç‡</strong></p>
                <p><strong>åˆ¶é€ è´¹ç”¨ = å·¥æ—¶ Ã— è´¹ç”¨åˆ†é…ç‡</strong></p>
                <p><strong>å·¥åºæˆæœ¬ = äººå·¥æˆæœ¬ + åˆ¶é€ è´¹ç”¨</strong></p>
                <p><strong>ç´¯è®¡æˆæœ¬ = ä¸Šä¸€å·¥åºç´¯è®¡æˆæœ¬ + æœ¬å·¥åºæˆæœ¬</strong></p>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ4ï¼šæˆæœ¬æ±‡æ€» -->
        <div id="tab4" class="tab-content">
            <h2>äº§å“æ€»æˆæœ¬æ±‡æ€»</h2>

            <div class="cost-summary">
                <div class="cost-card">
                    <h3>ç›´æ¥ææ–™</h3>
                    <div class="amount" id="summaryMaterial">0.00å…ƒ</div>
                    <div class="percentage" id="summaryMaterialPercent">0%</div>
                </div>
                <div class="cost-card">
                    <h3>ç›´æ¥äººå·¥</h3>
                    <div class="amount" id="summaryLabor">0.00å…ƒ</div>
                    <div class="percentage" id="summaryLaborPercent">0%</div>
                </div>
                <div class="cost-card">
                    <h3>åˆ¶é€ è´¹ç”¨</h3>
                    <div class="amount" id="summaryOverhead">0.00å…ƒ</div>
                    <div class="percentage" id="summaryOverheadPercent">0%</div>
                </div>
                <div class="cost-card" style="grid-column: span 3; background: linear-gradient(135deg, #2196f3 0%, #1565c0 100%); color: white;">
                    <h3 style="color: white;">äº§å“æ€»æˆæœ¬</h3>
                    <div class="amount" style="color: white; font-size: 32pt;" id="summaryTotal">0.00å…ƒ</div>
                </div>
            </div>

            <h3>æˆæœ¬æ˜ç»†æ±‡æ€»è¡¨</h3>
            <table id="summaryTable">
                <thead>
                    <tr>
                        <th>é¡¹ç›®</th>
                        <th>ææ–™æˆæœ¬(å…ƒ)</th>
                        <th>äººå·¥æˆæœ¬(å…ƒ)</th>
                        <th>åˆ¶é€ è´¹ç”¨(å…ƒ)</th>
                        <th>åˆè®¡(å…ƒ)</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
                <tfoot>
                    <tr class="highlight-row">
                        <td><strong>æ€»è®¡</strong></td>
                        <td><strong id="totalMaterial2">0.00</strong></td>
                        <td><strong id="totalLabor2">0.00</strong></td>
                        <td><strong id="totalOverhead2">0.00</strong></td>
                        <td><strong id="grandTotal2">0.00</strong></td>
                    </tr>
                    <tr style="background: #e3f2fd;">
                        <td><strong>å æ¯”</strong></td>
                        <td><strong id="materialPercent2">0%</strong></td>
                        <td><strong id="laborPercent2">0%</strong></td>
                        <td><strong id="overheadPercent2">0%</strong></td>
                        <td><strong>100%</strong></td>
                    </tr>
                </tfoot>
            </table>

            <div class="chart-container">
                <h3>æ–™å·¥è´¹å æ¯”åˆ†æ</h3>
                <canvas id="costPieChart" width="400" height="200"></canvas>
            </div>

            <div class="summary-box">
                <h3>ğŸ’¡ æˆæœ¬ç»“æ„åˆ†æ</h3>
                <p id="costStructureAnalysis">æ­£åœ¨è®¡ç®—...</p>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ2ï¼šBOMä¸ææ–™æˆæœ¬ -->
        <div id="tab2" class="tab-content">
            <h2>BOMä¸ææ–™æˆæœ¬è®¡ç®—</h2>

            <h3>äº§å“BOMæ¸…å•</h3>
            <table id="bomTable">
                <thead>
                    <tr>
                        <th>ç‰©æ–™ç¼–ç </th>
                        <th>ç‰©æ–™åç§°</th>
                        <th>è§„æ ¼</th>
                        <th>å•ä½</th>
                        <th>å‡€ç”¨é‡</th>
                        <th>æŸè€—ç‡(%)</th>
                        <th>æ¶ˆè€—é‡</th>
                        <th>å•ä»·(å…ƒ)</th>
                        <th>ææ–™æˆæœ¬(å…ƒ)</th>
                    </tr>
                </thead>
                <tbody id="bomTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
                <tfoot>
                    <tr class="highlight-row">
                        <td colspan="8" style="text-align: right;"><strong>ææ–™æˆæœ¬åˆè®¡ï¼š</strong></td>
                        <td><strong id="totalMaterialCost">0.00</strong></td>
                    </tr>
                </tfoot>
            </table>

            <div class="summary-box">
                <h3>ğŸ“ è®¡ç®—å…¬å¼</h3>
                <p><strong>æ¶ˆè€—é‡ = å‡€ç”¨é‡ Ã— (1 + æŸè€—ç‡)</strong></p>
                <p><strong>ææ–™æˆæœ¬ = æ¶ˆè€—é‡ Ã— å•ä»·</strong></p>
                <p><strong>ææ–™æˆæœ¬åˆè®¡ = Î£(æ‰€æœ‰ææ–™æˆæœ¬)</strong></p>
            </div>

            <div class="cost-summary">
                <div class="cost-card">
                    <h3>ä¸»ææ–™æˆæœ¬</h3>
                    <div class="amount" id="mainMaterialCost">0.00å…ƒ</div>
                    <div class="percentage" id="mainMaterialPercent">0%</div>
                </div>
                <div class="cost-card">
                    <h3>è¾…åŠ©ææ–™æˆæœ¬</h3>
                    <div class="amount" id="auxMaterialCost">0.00å…ƒ</div>
                    <div class="percentage" id="auxMaterialPercent">0%</div>
                </div>
                <div class="cost-card">
                    <h3>åŒ…è£…ææ–™æˆæœ¬</h3>
                    <div class="amount" id="packMaterialCost">0.00å…ƒ</div>
                    <div class="percentage" id="packMaterialPercent">0%</div>
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ5ï¼šæˆæœ¬åˆ†æ -->
        <div id="tab5" class="tab-content">
            <h2>æˆæœ¬åˆ†æä¸å¼‚å¸¸è¯†åˆ«</h2>

            <h3>æˆæœ¬å·®å¼‚åˆ†æ</h3>
            <div class="summary-box">
                <p><strong>æ ‡å‡†æˆæœ¬è®¾ç½®ï¼š</strong>è¯·è¾“å…¥æ ‡å‡†æˆæœ¬è¿›è¡Œå¯¹æ¯”åˆ†æ</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                    <div>
                        <label>æ ‡å‡†ææ–™æˆæœ¬(å…ƒ)ï¼š</label>
                        <input type="number" id="stdMaterialCost" value="7.30" step="0.01" onchange="analyzeVariance()">
                    </div>
                    <div>
                        <label>æ ‡å‡†äººå·¥æˆæœ¬(å…ƒ)ï¼š</label>
                        <input type="number" id="stdLaborCost" value="20.10" step="0.01" onchange="analyzeVariance()">
                    </div>
                    <div>
                        <label>æ ‡å‡†åˆ¶é€ è´¹ç”¨(å…ƒ)ï¼š</label>
                        <input type="number" id="stdOverheadCost" value="52.24" step="0.01" onchange="analyzeVariance()">
                    </div>
                </div>
            </div>

            <table id="varianceTable">
                <thead>
                    <tr>
                        <th>é¡¹ç›®</th>
                        <th>æ ‡å‡†æˆæœ¬(å…ƒ)</th>
                        <th>å®é™…æˆæœ¬(å…ƒ)</th>
                        <th>å·®å¼‚(å…ƒ)</th>
                        <th>å·®å¼‚ç‡(%)</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="varianceTableBody">
                    <!-- æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>

            <h3>å¼‚å¸¸æˆæœ¬è¯†åˆ«</h3>
            <div id="abnormalAlerts">
                <!-- å¼‚å¸¸æç¤ºå°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>

            <h3>æˆæœ¬æ”¹å–„å»ºè®®</h3>
            <div class="summary-box">
                <h4>ğŸ“Š åŸºäºæˆæœ¬ç»“æ„çš„æ”¹å–„æ–¹å‘</h4>
                <div id="improvementSuggestions">
                    <!-- æ”¹å–„å»ºè®®å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
            </div>

            <div class="summary-box" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left-color: #4caf50;">
                <h4>ğŸ’¡ æˆæœ¬åˆ†æ"å››é—®"æ¡†æ¶</h4>
                <ol>
                    <li><strong>é’±èŠ±åœ¨å“ªé‡Œäº†ï¼Ÿ</strong> â†’ æˆæœ¬æ„æˆåˆ†æï¼ˆæ–™å·¥è´¹å æ¯”ï¼‰</li>
                    <li><strong>èŠ±å¾—å¯¹ä¸å¯¹ï¼Ÿ</strong> â†’ æˆæœ¬å·®å¼‚åˆ†æï¼ˆä¸æ ‡å‡†å¯¹æ¯”ï¼‰</li>
                    <li><strong>æœ‰æ²¡æœ‰å¼‚å¸¸ï¼Ÿ</strong> â†’ å¼‚å¸¸æˆæœ¬è¯†åˆ«ï¼ˆè¶…å‡ºåˆç†èŒƒå›´ï¼‰</li>
                    <li><strong>å¦‚ä½•æ”¹è¿›ï¼Ÿ</strong> â†’ æ”¹å–„æœºä¼šåˆ†æï¼ˆé™æœ¬å¢æ•ˆæ–¹å‘ï¼‰</li>
                </ol>
            </div>
        </div>

    </div>

    <script>
    // åŸºç¡€æ•°æ®å®šä¹‰
    const materials = [
        {code: 'M-001', name: 'GCr15é’¢æ', spec: 'Ï†30mm', unit: 'kg', price: 12.50, lossRate: 0.05},
        {code: 'M-002', name: 'é’¢çƒ', spec: 'Ï†9.525mm', unit: 'ä¸ª', price: 0.15, lossRate: 0.02},
        {code: 'M-003', name: 'æ¶¦æ»‘è„‚', spec: 'é”‚åŸºè„‚', unit: 'g', price: 0.08, lossRate: 0.03},
        {code: 'M-004', name: 'é˜²é”ˆçº¸', spec: '-', unit: 'g', price: 0.02, lossRate: 0.02},
        {code: 'M-005', name: 'å¡‘æ–™è¢‹', spec: 'PEè¢‹', unit: 'ä¸ª', price: 0.05, lossRate: 0.01},
        {code: 'M-006', name: 'ä½ç¢³é’¢æ¿', spec: 'Q235', unit: 'kg', price: 8.00, lossRate: 0.04},
        {code: 'M-007', name: 'åŒ…è£…çº¸ç›’', spec: '-', unit: 'ä¸ª', price: 0.30, lossRate: 0.02}
    ];

    const processes = [
        {code: 'P-001', name: 'é”»é€ ', wageRate: 34, monthlyOverhead: 180000, driver: 'æœºå™¨å·¥æ—¶', driverQty: 2000, rate: 90},
        {code: 'P-002', name: 'è½¦å‰Š', wageRate: 40, monthlyOverhead: 250000, driver: 'æœºå™¨å·¥æ—¶', driverQty: 3000, rate: 83},
        {code: 'P-003', name: 'çƒ­å¤„ç†', wageRate: 37, monthlyOverhead: 120000, driver: 'ç‚‰æ—¶', driverQty: 800, rate: 150},
        {code: 'P-004', name: 'ç£¨å‰Š', wageRate: 45, monthlyOverhead: 150000, driver: 'æœºå™¨å·¥æ—¶', driverQty: 1500, rate: 100},
        {code: 'P-005', name: 'è£…é…', wageRate: 37, monthlyOverhead: 50000, driver: 'äººå·¥å·¥æ—¶', driverQty: 2500, rate: 20},
        {code: 'P-006', name: 'æ£€éªŒ', wageRate: 37, monthlyOverhead: 50000, driver: 'äººå·¥å·¥æ—¶', driverQty: 2500, rate: 20}
    ];

    // äº§å“BOM
    const bom = [
        {materialCode: 'M-001', netQty: 0.40, category: 'main'},
        {materialCode: 'M-002', netQty: 9, category: 'main'},
        {materialCode: 'M-003', netQty: 5, category: 'aux'},
        {materialCode: 'M-004', netQty: 10, category: 'pack'},
        {materialCode: 'M-005', netQty: 1, category: 'pack'},
        {materialCode: 'M-006', netQty: 0.016, category: 'main'},
        {materialCode: 'M-007', netQty: 1, category: 'pack'}
    ];

    // å·¥åºè·¯çº¿
    const routes = {
        innerRing: [
            {processCode: 'P-001', timeMin: 0.5, materialCost: 1.58},
            {processCode: 'P-002', timeMin: 2.0},
            {processCode: 'P-003', timeMin: 4.0},
            {processCode: 'P-004', timeMin: 5.0}
        ],
        outerRing: [
            {processCode: 'P-001', timeMin: 0.5, materialCost: 2.36},
            {processCode: 'P-002', timeMin: 2.5},
            {processCode: 'P-003', timeMin: 4.0},
            {processCode: 'P-004', timeMin: 6.0}
        ],
        cage: [
            {processCode: 'P-002', timeMin: 1.5, materialCost: 0.13}
        ],
        assembly: [
            {processCode: 'P-005', timeMin: 2.0},
            {processCode: 'P-006', timeMin: 1.0}
        ]
    };

    // å…¨å±€å˜é‡å­˜å‚¨è®¡ç®—ç»“æœ
    let costResults = {
        material: 0,
        labor: 0,
        overhead: 0,
        total: 0
    };

    // è¯¦ç»†æˆæœ¬ç»“æœ
    let detailedCosts = {
        materialTotal: 0,
        mainMaterial: 0,
        auxMaterial: 0,
        packMaterial: 0,
        innerRing: { labor: 0, overhead: 0, total: 0 },
        outerRing: { labor: 0, overhead: 0, total: 0 },
        cage: { labor: 0, overhead: 0, total: 0 },
        assembly: { labor: 0, overhead: 0, total: 0 }
    };

    // ==================== Tabåˆ‡æ¢åŠŸèƒ½ ====================
    function showTab(tabId) {
        // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.tab').forEach(btn => {
            btn.classList.remove('active');
        });
        // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
        document.getElementById(tabId).classList.add('active');
        // æ¿€æ´»å¯¹åº”æŒ‰é’®
        event.target.classList.add('active');
    }

    // ==================== è¾…åŠ©å‡½æ•° ====================
    function getMaterial(code) {
        return materials.find(m => m.code === code);
    }

    function getProcess(code) {
        return processes.find(p => p.code === code);
    }

    function formatNumber(num, decimals = 2) {
        return Number(num).toFixed(decimals);
    }

    // ==================== ç‰©æ–™ä¸»æ•°æ®è¡¨æ ¼å¡«å…… ====================
    function renderMaterialTable() {
        const tbody = document.getElementById('materialTableBody');
        tbody.innerHTML = materials.map(m => `
            <tr>
                <td>${m.code}</td>
                <td>${m.name}</td>
                <td>${m.spec}</td>
                <td>${m.unit}</td>
                <td><input type="number" value="${m.price}" step="0.01" 
                    onchange="updateMaterialPrice('${m.code}', this.value)"></td>
                <td><input type="number" value="${(m.lossRate * 100).toFixed(1)}" step="0.1" 
                    onchange="updateMaterialLossRate('${m.code}', this.value)"></td>
            </tr>
        `).join('');
    }

    // ==================== å·¥åºä¸»æ•°æ®è¡¨æ ¼å¡«å…… ====================
    function renderProcessTable() {
        const tbody = document.getElementById('processTableBody');
        tbody.innerHTML = processes.map(p => `
            <tr>
                <td>${p.code}</td>
                <td>${p.name}</td>
                <td><input type="number" value="${p.wageRate}" step="1" 
                    onchange="updateProcessWageRate('${p.code}', this.value)"></td>
                <td>${p.monthlyOverhead.toLocaleString()}</td>
                <td>${p.driver}</td>
                <td>${p.driverQty.toLocaleString()}</td>
                <td>${p.rate}</td>
            </tr>
        `).join('');
    }

    // ==================== æ›´æ–°æ•°æ®å‡½æ•° ====================
    function updateMaterialPrice(code, value) {
        const material = getMaterial(code);
        if (material) {
            material.price = parseFloat(value) || 0;
            calculateAll();
        }
    }

    function updateMaterialLossRate(code, value) {
        const material = getMaterial(code);
        if (material) {
            material.lossRate = (parseFloat(value) || 0) / 100;
            calculateAll();
        }
    }

    function updateProcessWageRate(code, value) {
        const process = getProcess(code);
        if (process) {
            process.wageRate = parseFloat(value) || 0;
            calculateAll();
        }
    }

    // ==================== BOMä¸ææ–™æˆæœ¬è®¡ç®— ====================
    function calculateMaterialCost() {
        let totalMaterial = 0;
        let mainMaterial = 0;
        let auxMaterial = 0;
        let packMaterial = 0;

        const tbody = document.getElementById('bomTableBody');
        tbody.innerHTML = bom.map(item => {
            const material = getMaterial(item.materialCode);
            if (!material) return '';

            const consumption = item.netQty * (1 + material.lossRate);
            const cost = consumption * material.price;
            totalMaterial += cost;

            // åˆ†ç±»ç»Ÿè®¡
            if (item.category === 'main') mainMaterial += cost;
            else if (item.category === 'aux') auxMaterial += cost;
            else if (item.category === 'pack') packMaterial += cost;

            return `
                <tr>
                    <td>${material.code}</td>
                    <td>${material.name}</td>
                    <td>${material.spec}</td>
                    <td>${material.unit}</td>
                    <td>${item.netQty}</td>
                    <td>${(material.lossRate * 100).toFixed(1)}%</td>
                    <td>${formatNumber(consumption, 4)}</td>
                    <td>${formatNumber(material.price)}</td>
                    <td>${formatNumber(cost)}</td>
                </tr>
            `;
        }).join('');

        // æ›´æ–°åˆè®¡
        document.getElementById('totalMaterialCost').textContent = formatNumber(totalMaterial);

        // æ›´æ–°åˆ†ç±»ç»Ÿè®¡å¡ç‰‡
        document.getElementById('mainMaterialCost').textContent = formatNumber(mainMaterial) + 'å…ƒ';
        document.getElementById('auxMaterialCost').textContent = formatNumber(auxMaterial) + 'å…ƒ';
        document.getElementById('packMaterialCost').textContent = formatNumber(packMaterial) + 'å…ƒ';

        // æ›´æ–°å æ¯”
        if (totalMaterial > 0) {
            document.getElementById('mainMaterialPercent').textContent = formatNumber(mainMaterial / totalMaterial * 100, 1) + '%';
            document.getElementById('auxMaterialPercent').textContent = formatNumber(auxMaterial / totalMaterial * 100, 1) + '%';
            document.getElementById('packMaterialPercent').textContent = formatNumber(packMaterial / totalMaterial * 100, 1) + '%';
        }

        // ä¿å­˜ç»“æœ
        detailedCosts.materialTotal = totalMaterial;
        detailedCosts.mainMaterial = mainMaterial;
        detailedCosts.auxMaterial = auxMaterial;
        detailedCosts.packMaterial = packMaterial;
        costResults.material = totalMaterial;

        return totalMaterial;
    }

    // ==================== å·¥åºæˆæœ¬è®¡ç®— ====================
    function calculateProcessCost(routeData, tbodyId, includeMaterial = false) {
        const tbody = document.getElementById(tbodyId);
        let cumulativeCost = 0;
        let totalLabor = 0;
        let totalOverhead = 0;
        let rows = [];

        routeData.forEach((step, index) => {
            const process = getProcess(step.processCode);
            if (!process) return;

            const timeHour = step.timeMin / 60;
            const laborCost = timeHour * process.wageRate;
            const overheadCost = timeHour * process.rate;
            const processCost = laborCost + overheadCost;

            // å¦‚æœæ˜¯é¦–é“å·¥åºä¸”æœ‰ææ–™æˆæœ¬
            if (index === 0 && step.materialCost) {
                cumulativeCost += step.materialCost;
            }
            cumulativeCost += processCost;

            totalLabor += laborCost;
            totalOverhead += overheadCost;

            rows.push(`
                <tr>
                    <td>${process.name}</td>
                    <td>${step.timeMin}</td>
                    <td>${formatNumber(timeHour, 4)}</td>
                    <td>${process.wageRate}</td>
                    <td>${formatNumber(laborCost)}</td>
                    <td>${process.rate}</td>
                    <td>${formatNumber(overheadCost)}</td>
                    <td>${formatNumber(processCost)}</td>
                    ${tbodyId !== 'assemblyTableBody' ? `<td>${formatNumber(cumulativeCost)}</td>` : ''}
                </tr>
            `);
        });

        // æ·»åŠ å°è®¡è¡Œ
        const totalProcessCost = totalLabor + totalOverhead;
        rows.push(`
            <tr class="highlight-row">
                <td><strong>å°è®¡</strong></td>
                <td></td>
                <td></td>
                <td></td>
                <td><strong>${formatNumber(totalLabor)}</strong></td>
                <td></td>
                <td><strong>${formatNumber(totalOverhead)}</strong></td>
                <td><strong>${formatNumber(totalProcessCost)}</strong></td>
                ${tbodyId !== 'assemblyTableBody' ? `<td></td>` : ''}
            </tr>
        `);

        tbody.innerHTML = rows.join('');

        return { labor: totalLabor, overhead: totalOverhead, total: totalProcessCost };
    }

    // ==================== è®¡ç®—æ‰€æœ‰å·¥åºæˆæœ¬ ====================
    function calculateAllProcessCosts() {
        // å†…åœˆ
        detailedCosts.innerRing = calculateProcessCost(routes.innerRing, 'innerRingTableBody', true);
        
        // å¤–åœˆ
        detailedCosts.outerRing = calculateProcessCost(routes.outerRing, 'outerRingTableBody', true);
        
        // ä¿æŒæ¶ï¼ˆåˆå¹¶åˆ°è£…é…è¡¨æ ¼å‰å•ç‹¬è®¡ç®—ï¼‰
        let cageLabor = 0, cageOverhead = 0;
        routes.cage.forEach(step => {
            const process = getProcess(step.processCode);
            if (process) {
                const timeHour = step.timeMin / 60;
                cageLabor += timeHour * process.wageRate;
                cageOverhead += timeHour * process.rate;
            }
        });
        detailedCosts.cage = { labor: cageLabor, overhead: cageOverhead, total: cageLabor + cageOverhead };

        // è£…é…ä¸æ£€éªŒ
        detailedCosts.assembly = calculateProcessCost(routes.assembly, 'assemblyTableBody', false);

        // æ±‡æ€»äººå·¥å’Œåˆ¶é€ è´¹ç”¨
        costResults.labor = detailedCosts.innerRing.labor + detailedCosts.outerRing.labor + 
                           detailedCosts.cage.labor + detailedCosts.assembly.labor;
        costResults.overhead = detailedCosts.innerRing.overhead + detailedCosts.outerRing.overhead + 
                              detailedCosts.cage.overhead + detailedCosts.assembly.overhead;
    }

    // ==================== æˆæœ¬æ±‡æ€» ====================
    function calculateSummary() {
        costResults.total = costResults.material + costResults.labor + costResults.overhead;

        // æ›´æ–°æ±‡æ€»å¡ç‰‡
        document.getElementById('summaryMaterial').textContent = formatNumber(costResults.material) + 'å…ƒ';
        document.getElementById('summaryLabor').textContent = formatNumber(costResults.labor) + 'å…ƒ';
        document.getElementById('summaryOverhead').textContent = formatNumber(costResults.overhead) + 'å…ƒ';
        document.getElementById('summaryTotal').textContent = formatNumber(costResults.total) + 'å…ƒ';

        // æ›´æ–°å æ¯”
        if (costResults.total > 0) {
            const matPct = (costResults.material / costResults.total * 100).toFixed(1);
            const labPct = (costResults.labor / costResults.total * 100).toFixed(1);
            const ovhPct = (costResults.overhead / costResults.total * 100).toFixed(1);

            document.getElementById('summaryMaterialPercent').textContent = matPct + '%';
            document.getElementById('summaryLaborPercent').textContent = labPct + '%';
            document.getElementById('summaryOverheadPercent').textContent = ovhPct + '%';

            document.getElementById('materialPercent2').textContent = matPct + '%';
            document.getElementById('laborPercent2').textContent = labPct + '%';
            document.getElementById('overheadPercent2').textContent = ovhPct + '%';
        }

        // æ›´æ–°æ±‡æ€»è¡¨æ ¼
        renderSummaryTable();

        // æ›´æ–°æˆæœ¬ç»“æ„åˆ†æ
        updateCostStructureAnalysis();

        // æ›´æ–°å›¾è¡¨
        renderPieChart();
    }

    // ==================== æ±‡æ€»è¡¨æ ¼ ====================
    function renderSummaryTable() {
        const tbody = document.getElementById('summaryTableBody');
        
        const summaryData = [
            { name: 'å†…åœˆåŠ å·¥', material: routes.innerRing[0].materialCost || 0, labor: detailedCosts.innerRing.labor, overhead: detailedCosts.innerRing.overhead },
            { name: 'å¤–åœˆåŠ å·¥', material: routes.outerRing[0].materialCost || 0, labor: detailedCosts.outerRing.labor, overhead: detailedCosts.outerRing.overhead },
            { name: 'ä¿æŒæ¶åŠ å·¥', material: routes.cage[0].materialCost || 0, labor: detailedCosts.cage.labor, overhead: detailedCosts.cage.overhead },
            { name: 'é’¢çƒ', material: 9 * getMaterial('M-002').price * (1 + getMaterial('M-002').lossRate), labor: 0, overhead: 0 },
            { name: 'æ¶¦æ»‘è„‚', material: 5 * getMaterial('M-003').price * (1 + getMaterial('M-003').lossRate), labor: 0, overhead: 0 },
            { name: 'åŒ…è£…ææ–™', material: detailedCosts.packMaterial, labor: 0, overhead: 0 },
            { name: 'è£…é…æ£€éªŒ', material: 0, labor: detailedCosts.assembly.labor, overhead: detailedCosts.assembly.overhead }
        ];

        tbody.innerHTML = summaryData.map(item => {
            const total = item.material + item.labor + item.overhead;
            return `
                <tr>
                    <td>${item.name}</td>
                    <td>${formatNumber(item.material)}</td>
                    <td>${formatNumber(item.labor)}</td>
                    <td>${formatNumber(item.overhead)}</td>
                    <td>${formatNumber(total)}</td>
                </tr>
            `;
        }).join('');

        // æ›´æ–°åº•éƒ¨åˆè®¡
        document.getElementById('totalMaterial2').textContent = formatNumber(costResults.material);
        document.getElementById('totalLabor2').textContent = formatNumber(costResults.labor);
        document.getElementById('totalOverhead2').textContent = formatNumber(costResults.overhead);
        document.getElementById('grandTotal2').textContent = formatNumber(costResults.total);
    }

    // ==================== æˆæœ¬ç»“æ„åˆ†æ ====================
    function updateCostStructureAnalysis() {
        const analysis = document.getElementById('costStructureAnalysis');
        const matPct = (costResults.material / costResults.total * 100);
        const labPct = (costResults.labor / costResults.total * 100);
        const ovhPct = (costResults.overhead / costResults.total * 100);

        let insights = [];
        
        // åˆ†æææ–™å æ¯”
        if (matPct < 15) {
            insights.push(`<strong>ææ–™æˆæœ¬å æ¯”è¾ƒä½(${matPct.toFixed(1)}%)</strong>ï¼Œè¯´æ˜è¯¥äº§å“ä¸ºåŠ å·¥å¯†é›†å‹ï¼Œäººå·¥å’Œè®¾å¤‡æŠ•å…¥æ˜¯æˆæœ¬ä¸»è¦æ¥æºã€‚`);
        } else if (matPct > 40) {
            insights.push(`<strong>ææ–™æˆæœ¬å æ¯”è¾ƒé«˜(${matPct.toFixed(1)}%)</strong>ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨åŸææ–™é‡‡è´­ä»·æ ¼å’ŒæŸè€—æ§åˆ¶ã€‚`);
        }

        // åˆ†æåˆ¶é€ è´¹ç”¨å æ¯”
        if (ovhPct > 50) {
            insights.push(`<strong>åˆ¶é€ è´¹ç”¨å æ¯”é«˜è¾¾${ovhPct.toFixed(1)}%</strong>ï¼Œè¡¨æ˜è®¾å¤‡æŠ˜æ—§å’Œèƒ½è€—æ˜¯ä¸»è¦æˆæœ¬é©±åŠ¨å› ç´ ï¼Œåº”å…³æ³¨è®¾å¤‡åˆ©ç”¨ç‡å’Œäº§èƒ½ä¼˜åŒ–ã€‚`);
        }

        // åˆ†æäººå·¥å æ¯”
        if (labPct > 30) {
            insights.push(`<strong>äººå·¥æˆæœ¬å æ¯”${labPct.toFixed(1)}%</strong>ï¼Œå¯è€ƒè™‘é€šè¿‡è‡ªåŠ¨åŒ–æ”¹é€ æˆ–å·¥è‰ºä¼˜åŒ–æ¥æé«˜äººæ•ˆã€‚`);
        }

        // å·¥åºåˆ†æ
        const totalProcessCost = detailedCosts.innerRing.total + detailedCosts.outerRing.total + 
                                detailedCosts.cage.total + detailedCosts.assembly.total;
        const grindingCost = (routes.innerRing[3] ? routes.innerRing[3].timeMin / 60 * (getProcess('P-004').wageRate + getProcess('P-004').rate) : 0) +
                            (routes.outerRing[3] ? routes.outerRing[3].timeMin / 60 * (getProcess('P-004').wageRate + getProcess('P-004').rate) : 0);
        
        if (grindingCost / totalProcessCost > 0.3) {
            insights.push(`<strong>ç£¨å‰Šå·¥åºæˆæœ¬å åŠ å·¥æˆæœ¬çš„${(grindingCost / totalProcessCost * 100).toFixed(1)}%</strong>ï¼Œæ˜¯æˆæœ¬æœ€é«˜çš„å·¥åºï¼Œå¯é‡ç‚¹ä¼˜åŒ–ç£¨å‰Šæ•ˆç‡ã€‚`);
        }

        analysis.innerHTML = insights.length > 0 ? 
            '<ul>' + insights.map(i => `<li>${i}</li>`).join('') + '</ul>' :
            '<p>æˆæœ¬ç»“æ„å‡è¡¡ï¼Œå„é¡¹æˆæœ¬å æ¯”å¤„äºåˆç†èŒƒå›´ã€‚</p>';
    }

    // ==================== å·®å¼‚åˆ†æ ====================
    function analyzeVariance() {
        const stdMaterial = parseFloat(document.getElementById('stdMaterialCost').value) || 0;
        const stdLabor = parseFloat(document.getElementById('stdLaborCost').value) || 0;
        const stdOverhead = parseFloat(document.getElementById('stdOverheadCost').value) || 0;
        const stdTotal = stdMaterial + stdLabor + stdOverhead;

        const variances = [
            { name: 'ç›´æ¥ææ–™', std: stdMaterial, actual: costResults.material },
            { name: 'ç›´æ¥äººå·¥', std: stdLabor, actual: costResults.labor },
            { name: 'åˆ¶é€ è´¹ç”¨', std: stdOverhead, actual: costResults.overhead },
            { name: 'æ€»æˆæœ¬', std: stdTotal, actual: costResults.total }
        ];

        const tbody = document.getElementById('varianceTableBody');
        tbody.innerHTML = variances.map(v => {
            const diff = v.actual - v.std;
            const diffRate = v.std > 0 ? (diff / v.std * 100) : 0;
            let status = '';
            let statusClass = '';

            if (Math.abs(diffRate) <= 3) {
                status = 'âœ“ æ­£å¸¸';
                statusClass = 'alert-success';
            } else if (diffRate > 3 && diffRate <= 10) {
                status = 'âš  åé«˜';
                statusClass = 'alert-warning';
            } else if (diffRate > 10) {
                status = 'âŒ å¼‚å¸¸é«˜';
                statusClass = 'alert-danger';
            } else if (diffRate < -3 && diffRate >= -10) {
                status = 'â†“ åä½';
                statusClass = 'alert-success';
            } else if (diffRate < -10) {
                status = 'â¬‡ æ˜¾è‘—ä½';
                statusClass = 'alert-success';
            }

            return `
                <tr>
                    <td>${v.name}</td>
                    <td>${formatNumber(v.std)}</td>
                    <td>${formatNumber(v.actual)}</td>
                    <td style="color: ${diff > 0 ? '#dc3545' : '#28a745'}">${diff > 0 ? '+' : ''}${formatNumber(diff)}</td>
                    <td style="color: ${diff > 0 ? '#dc3545' : '#28a745'}">${diff > 0 ? '+' : ''}${formatNumber(diffRate, 1)}%</td>
                    <td><span class="${statusClass}" style="padding: 5px 10px; border-radius: 5px;">${status}</span></td>
                </tr>
            `;
        }).join('');

        // å¼‚å¸¸æç¤º
        updateAbnormalAlerts(variances);
        
        // æ”¹å–„å»ºè®®
        updateImprovementSuggestions(variances);
    }

    // ==================== å¼‚å¸¸æç¤º ====================
    function updateAbnormalAlerts(variances) {
        const container = document.getElementById('abnormalAlerts');
        let alerts = [];

        variances.forEach(v => {
            const diff = v.actual - v.std;
            const diffRate = v.std > 0 ? (diff / v.std * 100) : 0;

            if (diffRate > 10) {
                alerts.push(`
                    <div class="alert alert-danger">
                        <strong>${v.name}å¼‚å¸¸åé«˜ï¼</strong> 
                        å®é™…æˆæœ¬${formatNumber(v.actual)}å…ƒï¼Œè¶…å‡ºæ ‡å‡†${formatNumber(Math.abs(diff))}å…ƒ(${formatNumber(Math.abs(diffRate), 1)}%)ï¼Œ
                        å»ºè®®ç«‹å³æ’æŸ¥åŸå› ã€‚
                    </div>
                `);
            } else if (diffRate > 3) {
                alerts.push(`
                    <div class="alert alert-warning">
                        <strong>${v.name}è½»å¾®åé«˜</strong> 
                        è¶…å‡ºæ ‡å‡†${formatNumber(Math.abs(diff))}å…ƒ(${formatNumber(Math.abs(diffRate), 1)}%)ï¼Œå»ºè®®å…³æ³¨ã€‚
                    </div>
                `);
            }
        });

        if (alerts.length === 0) {
            alerts.push(`
                <div class="alert alert-success">
                    <strong>âœ“ æˆæœ¬æ­£å¸¸</strong> 
                    æ‰€æœ‰æˆæœ¬é¡¹ç›®å‡åœ¨æ ‡å‡†èŒƒå›´å†…ï¼Œæ— å¼‚å¸¸æƒ…å†µã€‚
                </div>
            `);
        }

        container.innerHTML = alerts.join('');
    }

    // ==================== æ”¹å–„å»ºè®® ====================
    function updateImprovementSuggestions(variances) {
        const container = document.getElementById('improvementSuggestions');
        let suggestions = [];

        // åŸºäºæˆæœ¬ç»“æ„ç»™å‡ºå»ºè®®
        const matPct = costResults.material / costResults.total * 100;
        const labPct = costResults.labor / costResults.total * 100;
        const ovhPct = costResults.overhead / costResults.total * 100;

        if (ovhPct > 50) {
            suggestions.push({
                priority: 'é«˜',
                area: 'åˆ¶é€ è´¹ç”¨ä¼˜åŒ–',
                actions: [
                    'æé«˜è®¾å¤‡åˆ©ç”¨ç‡ï¼Œå‡å°‘ç©ºè½¬æ—¶é—´',
                    'ä¼˜åŒ–æ’äº§è®¡åˆ’ï¼Œå¢åŠ æ‰¹é‡ç”Ÿäº§æ¯”ä¾‹',
                    'è¯„ä¼°è®¾å¤‡èƒ½æ•ˆï¼Œè€ƒè™‘èŠ‚èƒ½æ”¹é€ ',
                    'åˆ†æå„å·¥åºè´¹ç”¨åˆ†é…ç‡ï¼Œé‡ç‚¹ä¼˜åŒ–é«˜è´¹ç‡å·¥åº'
                ]
            });
        }

        if (matPct > 20) {
            suggestions.push({
                priority: 'ä¸­',
                area: 'ææ–™æˆæœ¬æ§åˆ¶',
                actions: [
                    'ä¸ä¾›åº”å•†è®®ä»·ï¼Œäº‰å–æ›´ä¼˜é‡‡è´­ä»·æ ¼',
                    'ä¼˜åŒ–å·¥è‰ºå‡å°‘ææ–™æŸè€—',
                    'è¯„ä¼°æ›¿ä»£ææ–™å¯è¡Œæ€§',
                    'åŠ å¼ºåº“å­˜ç®¡ç†ï¼Œå‡å°‘å‘†æ»æŸå¤±'
                ]
            });
        }

        if (labPct > 25) {
            suggestions.push({
                priority: 'ä¸­',
                area: 'äººå·¥æ•ˆç‡æå‡',
                actions: [
                    'ä¼˜åŒ–ä½œä¸šæ ‡å‡†å·¥æ—¶',
                    'åŠ å¼ºæ“ä½œæŠ€èƒ½åŸ¹è®­',
                    'å¼•å…¥è‡ªåŠ¨åŒ–è®¾å¤‡æ›¿ä»£äººå·¥',
                    'ä¼˜åŒ–è½¦é—´å¸ƒå±€å‡å°‘æ¬è¿æ—¶é—´'
                ]
            });
        }

        // åŸºäºå·®å¼‚åˆ†æç»™å‡ºå»ºè®®
        variances.forEach(v => {
            const diffRate = v.std > 0 ? ((v.actual - v.std) / v.std * 100) : 0;
            if (diffRate > 5 && v.name !== 'æ€»æˆæœ¬') {
                suggestions.push({
                    priority: diffRate > 10 ? 'ç´§æ€¥' : 'é«˜',
                    area: `${v.name}å·®å¼‚æ•´æ”¹`,
                    actions: [
                        `æ’æŸ¥${v.name}è¶…æ ‡åŸå› `,
                        'å¯¹æ¯”å†å²æ•°æ®åˆ†æè¶‹åŠ¿',
                        'åˆ¶å®šä¸“é¡¹æ•´æ”¹æªæ–½',
                        'è·Ÿè¸ªæ•´æ”¹æ•ˆæœ'
                    ]
                });
            }
        });

        if (suggestions.length === 0) {
            container.innerHTML = '<p class="alert alert-success">å½“å‰æˆæœ¬ç»“æ„è‰¯å¥½ï¼Œå»ºè®®æŒç»­ä¿æŒå¹¶å…³æ³¨å¸‚åœºä»·æ ¼å˜åŒ–ã€‚</p>';
        } else {
            container.innerHTML = suggestions.map(s => `
                <div style="margin-bottom: 20px; padding: 15px; background: ${s.priority === 'ç´§æ€¥' ? '#ffebee' : s.priority === 'é«˜' ? '#fff3e0' : '#e3f2fd'}; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0; color: ${s.priority === 'ç´§æ€¥' ? '#c62828' : s.priority === 'é«˜' ? '#e65100' : '#1565c0'};">
                        [${s.priority}ä¼˜å…ˆ] ${s.area}
                    </h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${s.actions.map(a => `<li>${a}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }
    }

    // ==================== é¥¼å›¾ç»‘å®š ====================
    function renderPieChart() {
        const canvas = document.getElementById('costPieChart');
        const ctx = canvas.getContext('2d');
        
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const data = [
            { label: 'ç›´æ¥ææ–™', value: costResults.material, color: '#4caf50' },
            { label: 'ç›´æ¥äººå·¥', value: costResults.labor, color: '#2196f3' },
            { label: 'åˆ¶é€ è´¹ç”¨', value: costResults.overhead, color: '#ff9800' }
        ];
        
        const total = data.reduce((sum, d) => sum + d.value, 0);
        if (total === 0) return;
        
        const centerX = 150;
        const centerY = 100;
        const radius = 80;
        let startAngle = -Math.PI / 2;
        
        // ç»˜åˆ¶é¥¼å›¾
        data.forEach(d => {
            const sliceAngle = (d.value / total) * 2 * Math.PI;
            
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = d.color;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            startAngle += sliceAngle;
        });
        
        // ç»˜åˆ¶å›¾ä¾‹
        let legendY = 30;
        data.forEach(d => {
            const pct = (d.value / total * 100).toFixed(1);
            
            ctx.fillStyle = d.color;
            ctx.fillRect(280, legendY, 20, 20);
            
            ctx.fillStyle = '#333';
            ctx.font = '12px Microsoft YaHei';
            ctx.fillText(`${d.label}: ${formatNumber(d.value)}å…ƒ (${pct}%)`, 310, legendY + 15);
            
            legendY += 35;
        });
        
        // ä¸­å¿ƒæ˜¾ç¤ºæ€»æˆæœ¬
        ctx.fillStyle = '#333';
        ctx.font = 'bold 14px Microsoft YaHei';
        ctx.textAlign = 'center';
        ctx.fillText('æ€»æˆæœ¬', centerX, centerY - 5);
        ctx.fillText(formatNumber(total) + 'å…ƒ', centerX, centerY + 15);
        ctx.textAlign = 'left';
    }

    // ==================== ä¸»è®¡ç®—å‡½æ•° ====================
    function calculateAll() {
        calculateMaterialCost();
        calculateAllProcessCosts();
        calculateSummary();
        analyzeVariance();
    }

    // ==================== é¡µé¢åˆå§‹åŒ– ====================
    function init() {
        renderMaterialTable();
        renderProcessTable();
        calculateAll();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.onload = init;
    </script>
</body>
</html>
